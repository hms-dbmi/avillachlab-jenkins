pipeline {
    agent any
    
    parameters {
        string(name: 'DISPLAY', defaultValue: '3', description: 'Weight for concept_node.DISPLAY')
        string(name: 'CONCEPT_PATH', defaultValue: '2', description: 'Weight for concept_node.CONCEPT_PATH')
        string(name: 'FULL_NAME', defaultValue: '1', description: 'Weight for dataset.FULL_NAME')
        string(name: 'DESCRIPTION', defaultValue: '1', description: 'Weight for dataset.DESCRIPTION')
        string(name: 'META_STR', defaultValue: '1', description: 'Weight for concept_node_meta_str')
    }

    environment {
        S3_PATH = "s3://${stack_s3_bucket}/configs/dictionary/weights.csv"
    }

    stages {
        stage('Build CSV') {
            steps {
                script {
                    def csvContent = """\
concept_node.DISPLAY,${params.DISPLAY}
concept_node.CONCEPT_PATH,${params.CONCEPT_PATH}
dataset.FULL_NAME,${params.FULL_NAME}
dataset.DESCRIPTION,${params.DESCRIPTION}
concept_node_meta_str,${params.META_STR}
"""

                    writeFile file: 'weights.csv', text: csvContent
                }
            }
        }

        stage('Archive CSV') {
            steps {
                archiveArtifacts artifacts: 'weights.csv', onlyIfSuccessful: true
            }
        }

        stage('Upload to S3') {
            steps {
                script {
                    sh "aws s3 cp weights.csv ${S3_PATH}"
                }
            }
        }
    }
}
